<?xml version="1.0" encoding="UTF-8"?>
<project name="Root" default="all">

   <property file="application-settings.properties" />

   <macrodef name="generate-all-sources">
      <attribute name="target" />
      <sequential>
         <dependset>
            <srcfilelist   dir="@{target}" files="disappgen.jar" />
            <targetfileset dir="distributeur-c/src-gen"    includes="**/*.h  , **/*.c"   />
            <targetfileset dir="distributeur-cpp/src-gen"  includes="**/*.hpp, **/*.cpp" />
            <targetfileset dir="distributeur-java/src-gen" includes="**/*.java" />
            <targetfileset dir="sc-c/src-gen"              includes="**/*.h  , **/*.c"   />
            <targetfileset dir="sc-cpp/src-gen"            includes="**/*.hpp, **/*.cpp" />
            <targetfileset dir="sc-java/src-gen"           includes="**/*.java" />
            <targetfileset dir="udt-c/src-gen"             includes="**/*.h  , **/*.c"   />
            <targetfileset dir="udt-cpp/src-gen"           includes="**/*.hpp, **/*.cpp" />
            <targetfileset dir="udt-java/src-gen"          includes="**/*.java" />
         </dependset>
         <java fork="true" classname="disapp.generator.Main">
            <classpath location="lib/antlr-runtime-3.3.jar" />
            <classpath location="lib/javax.activation-1.2.0.jar" />
            <classpath location="lib/javax.activation-api-1.2.0.jar" />
            <classpath location="lib/jaxb-api-2.3.1.jar" />
            <classpath location="lib/jaxb-core-2.3.0.jar" />
            <classpath location="lib/jaxb-impl-2.3.2.jar" />
            <classpath location="lib/ST4-4.0.4.jar" />
            <classpath location="disappgen.jar" />
            <arg value="--model=dab.xml" />
            <arg value="--deployment=@{target}" />
         </java>
      </sequential>
   </macrodef>

   <target name="disappgen"><ant dir="disappgen" target="jar" /></target>
   <target name="generate-one-component-per-process" depends="disappgen">
      <generate-all-sources target="." />
   </target>
   <target name="generate-several-components-per-process" depends="disappgen">
      <generate-all-sources target="alt" />
   </target>

   <target name="util-c"           ><exec dir="util-c"           executable="make" output="util-c/compile.log"           failonerror="true" /></target>
   <target name="dabtypes-c"       ><exec dir="dabtypes-c"       executable="make" output="dabtypes-c/compile.log"       failonerror="true" /></target>
   <target name="distributeur-c"   ><exec dir="distributeur-c"   executable="make" output="distributeur-c/compile.log"   failonerror="true" /></target>
   <target name="udt-c"            ><exec dir="udt-c"            executable="make" output="udt-c/compile.log"            failonerror="true" /></target>
   <target name="util-c-tests"     ><exec dir="util-c/tests"     executable="make"                                       failonerror="true" /></target>
                                                            
   <target name="util-cpp"         ><exec dir="util-cpp"         executable="make" output="util-cpp/compile.log"         failonerror="true" /></target>
   <target name="dabtypes-cpp"     ><exec dir="dabtypes-cpp"     executable="make" output="dabtypes-cpp/compile.log"     failonerror="true" /></target>
   <target name="udt-cpp"          ><exec dir="udt-cpp"          executable="make" output="udt-cpp/compile.log"          failonerror="true" /></target>
   <target name="util-cpp-tests"   ><exec dir="util-cpp/tests"   executable="make"                                       failonerror="true" /></target>

   <target name="util-java"        ><ant dir="util-java"         output="compile.log" /></target>
   <target name="dabtypes-java"    ><ant dir="dabtypes-java"     output="compile.log" /></target>
   <target name="distributeur-java"><ant dir="distributeur-java" output="compile.log" /></target>
   <target name="sc-java"          ><ant dir="sc-java"           output="compile.log" /></target>
   <target name="udt-java"         ><ant dir="udt-java"          output="compile.log" /></target>

   <target name="show-errors">
      <concat>
         <fileset dir="." includes="*/compile.log">
             <or>
                <contains text="error:"   casesensitive="false" />
                <contains text="warning:" casesensitive="false" />
                <contains text="Stop."    casesensitive="false" />
             </or>
         </fileset>
      </concat>
   </target>

   <target name="all" description="Produit tout en parallèle">
      <antcall target="generate-one-component-per-process" />
      <echo>

         Les fichiers de log de compilations sont nommés compile.log dans leur dossier respectif.

      </echo>
      <parallel>
         <sequential>
            <echo message="    -- Compilation C    --" />
            <antcall target="util-c" />
            <antcall target="dabtypes-c" />
            <parallel>
               <antcall target="distributeur-c" />
               <antcall target="udt-c" />
            </parallel>
         </sequential>
         <sequential>
            <echo message="    -- Compilation C++  --" />
            <antcall target="util-cpp" />
            <antcall target="dabtypes-cpp" />
            <parallel>
               <antcall target="udt-cpp" />
            </parallel>
         </sequential>
         <sequential>
            <echo message="    -- Compilation Java --" />
            <antcall target="util-java" />
            <antcall target="dabtypes-java" />
            <parallel>
               <antcall target="distributeur-java" />
               <antcall target="udt-java" />
               <antcall target="sc-java" />
            </parallel>
         </sequential>
      </parallel>
      <echo>

         Les fichiers de log de compilations sont nommés compile.log dans leur dossier respectif.

      </echo>
      <antcall target="show-errors" />
   </target>

   <target name="all-debug-build" description="Produit tout en série pour debugger la production">
      
      <echo message="    -- Génération des sources C, C++ et Java      --" />
      <antcall target="generate-one-component-per-process" />
      
      <echo message="    -- Compilation C    --" />
      <antcall target="util-c" />
      <antcall target="dabtypes-c" />
      <antcall target="distributeur-c" />
      <antcall target="udt-c" />

      <echo message="    -- Compilation C++  --" />
      <antcall target="util-cpp" />
      <antcall target="dabtypes-cpp" />
      <antcall target="udt-cpp" />

      <echo message="    -- Compilation Java --" />
      <antcall target="util-java" />
      <antcall target="dabtypes-java" />
      <antcall target="distributeur-java" />
      <antcall target="udt-java" />
      <antcall target="sc-java" />
   </target>

   <target name="run-c" depends="util-c,udt-c">
      <ant                    dir="sc-java"            target="run" />
      <exec executable="make" dir="distributeur-c"><arg value="run-1" /></exec>
      <exec executable="make" dir="udt-c"         ><arg value="run-1" /></exec>
   </target>

   <target name="run-c-win32" depends="util-c,udt-c">
      <ant                    dir="sc-java"            target="run" />
      <exec executable="make" dir="distributeur-c"><arg value="run-win32-1" /></exec>
      <exec executable="make" dir="udt-c"         ><arg value="run-win32-1" /></exec>
   </target>

   <target name="run-c-2" depends="util-c,udt-c">
      <ant                    dir="sc-java"            target="run" />
      <exec executable="make" dir="distributeur-c"><arg value="run-1" /></exec>
      <exec executable="make" dir="udt-c"         ><arg value="run-1" /></exec>
      <exec executable="make" dir="distributeur-c"><arg value="run-2" /></exec>
      <exec executable="make" dir="udt-c"         ><arg value="run-2" /></exec>
   </target>

   <target name="run-c-win32-2" depends="util-c,udt-c">
      <ant                    dir="sc-java"            target="run" />
      <exec executable="make" dir="distributeur-c"><arg value="run-win32-1" /></exec>
      <exec executable="make" dir="udt-c"         ><arg value="run-win32-1" /></exec>
      <exec executable="make" dir="distributeur-c"><arg value="run-win32-2" /></exec>
      <exec executable="make" dir="udt-c"         ><arg value="run-win32-2" /></exec>
   </target>

   <target name="run-cpp" depends="util-cpp,udt-cpp">
      <ant                    dir="sc-java"            target="run" />
      <ant                    dir="distributeur-java"  target="run-1" />
      <exec executable="make" dir="udt-cpp"       ><arg value="run-1" /></exec>
   </target>

   <target name="run-cpp-win32" depends="util-cpp,udt-cpp">
      <ant                    dir="sc-java"            target="run" />
      <ant                    dir="distributeur-java"  target="run-win32-1" />
      <exec executable="make" dir="udt-cpp"       ><arg value="run-win32-1" /></exec>
   </target>

   <target name="run-cpp-2" depends="util-cpp,udt-cpp">
      <ant                    dir="sc-java"            target="run" />
      <ant                    dir="distributeur-java"  target="run-1" />
      <exec executable="make" dir="udt-cpp"       ><arg value="run-1" /></exec>
      <ant                    dir="distributeur-java"  target="run-2" />
      <exec executable="make" dir="udt-cpp"       ><arg value="run-2" /></exec>
   </target>

   <target name="run-cpp-win32-2" depends="util-cpp,udt-cpp">
      <ant                    dir="sc-java"            target="run" />
      <ant                    dir="distributeur-java"  target="run-1" />
      <exec executable="make" dir="udt-cpp"       ><arg value="run-win32-1" /></exec>
      <ant                    dir="distributeur-java"  target="run-2" />
      <exec executable="make" dir="udt-cpp"       ><arg value="run-win32-2" /></exec>
   </target>

   <target name="run-java" depends="util-java,udt-java">
      <ant                    dir="sc-java"            target="run" />
      <ant                    dir="distributeur-java"  target="run-1" />
      <ant                    dir="udt-java"           target="run-1" />
   </target>

   <target name="run-java-2" depends="util-java,udt-java">
      <ant                    dir="sc-java"            target="run" />
      <ant                    dir="distributeur-java"  target="run-1" />
      <ant                    dir="udt-java"           target="run-1" />
      <ant                    dir="distributeur-java"  target="run-2" />
      <ant                    dir="udt-java"           target="run-2" />
   </target>

   <target name="clean">
      <ant  dir="distributeur-java" target="clean" />
      <ant  dir="sc-java"           target="clean" />
      <ant  dir="udt-java"          target="clean" />
      <ant  dir="dabtypes-java"     target="clean" />
      <ant  dir="util-java"         target="clean" />
      <ant  dir="disappgen"         target="clean" />
      
      <delete file="disappgen.jar" />
      <delete file="unite_de_traitement" />
      <delete file="unite_de_traitement-mingw32" />
      <delete file="UniteDeTraitement" />
      <delete file="UniteDeTraitement-mingw32" />
      
      <delete dir ="dab/bin" />

      <delete dir ="dabtypes-c/BUILD-mingw32" />
      <delete dir ="dabtypes-c/BUILD" />
      <delete file="dabtypes-c/compile.log" />
      <delete file="dabtypes-c/deps" />
      <delete file="dabtypes-c/generated-files.mk" />
      <delete dir ="dabtypes-c/inc-gen" />
      <delete dir ="dabtypes-c/lib" />
      <delete dir ="dabtypes-c/src-gen" />
      
      <delete dir ="dabtypes-cpp/BUILD-mingw32" />
      <delete dir ="dabtypes-cpp/BUILD" />
      <delete file="dabtypes-cpp/compile.log" />
      <delete file="dabtypes-cpp/deps" />
      <delete file="dabtypes-cpp/generated-files.mk" />
      <delete dir ="dabtypes-cpp/inc-gen" />
      <delete dir ="dabtypes-cpp/lib" />
      <delete dir ="dabtypes-cpp/src-gen" />
      
      <delete file="dabtypes-java/compile.log" />
      
      <delete dir ="disappgen/bin" />
      
      <delete dir ="sc/bin" />

      <delete dir ="udt-c/BUILD-mingw32" />
      <delete dir ="udt-c/BUILD" />
      <delete file="udt-c/compile.log" />
      <delete file="udt-c/deps" />
      <delete file="udt-c/generated-files.mk" />
      <delete dir ="udt-c/src-gen" />
      
      <delete dir ="udt-cpp/BUILD-mingw32" />
      <delete dir ="udt-cpp/BUILD" />
      <delete file="udt-cpp/compile.log" />
      <delete file="udt-cpp/deps" />
      <delete file="udt-cpp/generated-files.mk" />
      <delete dir ="udt-cpp/src-gen" />
      
      <delete dir ="udt-java/bin" />
      
      <delete dir ="util-c/BUILD-mingw32" />
      <delete dir ="util-c/BUILD" />
      <delete file="util-c/compile.log" />
      <delete file="util-c/deps" />
      <delete dir ="util-c/lib" />
      
      <delete dir ="util-cpp/BUILD-mingw32" />
      <delete dir ="util-cpp/BUILD" />
      <delete file="util-cpp/compile.log" />
      <delete file="util-cpp/deps" />
      <delete dir ="util-cpp/lib" />
      
      <delete dir ="util-java/bin" />
   </target>

</project>
