<?xml version="1.0" encoding="UTF-8"?>
<distributed-application xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:noNamespaceSchemaLocation="distributed-application.xsd"
   xmlns:xi="http://www.w3.org/2001/XInclude">
   <types module-name="dabtypes">

      <struct name="Carte">
         <field name="id" type="string" length="4"
            description="Identifiant de la carte" />
         <field name="code" type="string" length="4"
            description="Identifiant de la carte" />
         <field name="month" type="byte"
            description="Jour de péremption de la carte" />
         <field name="year" type="ushort"
            description="Année de péremption de la carte" />
         <field name="nbEssais" type="byte"
            description="Nombre d'essais en échec de la carte" />
      </struct>

      <struct name="Compte">
         <field name="id" type="string" length="4"
            description="Identifiant du compte" />
         <field name="solde" type="double"
            description="Solde du compte" />
         <field name="autorise" type="boolean"
            description="Le compte est-il autorisé ?" />
      </struct>

      <struct name="Information">
         <field name="carte" type="struct" userType="dabtypes.Carte"
            description="La carte utilisée pour la transaction" />
         <field name="compte" type="struct" userType="dabtypes.Compte"
            description="Le compte associé à la carte" />
      </struct>

      <struct name="EtatDuDab">
         <field name="etat" type="enum" userType="dabtypes.Etat"
            description="Etat courant de l'automate du composant Controleur" />
         <field name="soldeCaisse" type="double"
            description="Montant de la caisse en €" />
      </struct>

      <implementation language="C" src-dir="dabtypes-c/src-gen" module-name="DBT" />
      <implementation language="C++" src-dir="dabtypes-cpp/src-gen" module-name="hpms::dabtypes" />
      <implementation language="Java" src-dir="dabtypes-java/src-gen" module-name="hpms.dabtypes" />
   </types>

   <interface name="IHM">
      <event name="ejecterLaCarte" />
      <event name="ejecterLesBillets">
         <field name="montant" type="double"
            description="Montant à donner à l'utilisateur du DAB" />
      </event>
      <event name="confisquerLaCarte" />
      <event name="placerLesBilletsDansLaCorbeille" />
      <event name="arret" />
   </interface>

   <interface name="UniteDeTraitement">
      <data name="etatDuDab" type="dabtypes.EtatDuDab"
         description="Partage des données décrivant l'état du DAB" />
      <event name="rechargerLaCaisse">
         <field name="montant" type="double"
            description="Montant à rajouter dans la caisse" />
      </event>
      <event name="anomalie">
         <field name="anomalie" type="boolean"
            description="Anomalie active (true) ou inactive (false)" />
      </event>
      <event name="carteInseree">
         <field name="carteID" type="string" length="4"
            description="Identifiant de la carte" />
      </event>
      <event name="codeSaisi">
         <field name="code" type="string" length="4"
            description="Code de la carte" />
      </event>
      <event name="montantSaisi">
         <field name="montant" type="double"
            description="Montant du retrait en €" />
      </event>
      <event name="carteRetiree" />
      <event name="billetsRetires" />
      <event name="annulationDemandeeParLeClient" />
      <event name="arret" />
   </interface>

   <interface name="Maintenable">
      <event name="maintenance">
         <field name="maintenance" type="boolean"
            description="Maintenance active (true) ou inactive (false)" />
      </event>
   </interface>

   <interface name="SiteCentral">
      <request name="informations" type="dabtypes.Information"
         description="Requête asynchrone auprès du site central qui retourne les informations de carte et de compte à partir de l'id de carte">
         <arguments>
            <field name="carteID" type="string" length="4"
               description="Identifiant de la carte" />
         </arguments>
      </request>
      <event name="incrNbEssais">
         <field name="carteID" type="string" length="4"
            description="Identifiant de la carte" />
      </event>
      <event name="retrait">
         <field name="carteID" type="string" length="4"
            description="Identifiant de la carte" />
         <field name="montant" type="double"
            description="Montant du retrait en €" />
      </event>
      <event name="arret" />
   </interface>

   <component name="Distributeur">
      <offers interface="IHM" />
      <requires interface="Maintenable" />
      <requires interface="UniteDeTraitement" />
      <implementation language="C" src-dir="Distributeur-c/src-gen" module-name="DAB" />
      <implementation language="C++" src-dir="Distributeur-cpp/src-gen" module-name="hpms::dab" />
      <implementation language="Java" src-dir="Distributeur-java/src-gen" module-name="hpms.dab" />
      <implementation language="Java" src-dir="Distributeur-java-script/src-gen" module-name="hpms.dab" />
   </component>

   <component name="Controleur">
      <offers interface="Maintenable" />
      <offers interface="UniteDeTraitement" />
      <requires interface="IHM" />
      <requires interface="SiteCentral" />
      <timeout name="saisieDuCode" duration="30" unit="seconds" />
      <timeout name="saisieDuMontant" duration="30" unit="seconds" />
      <timeout name="retraitDeLaCarte" duration="10" unit="seconds" />
      <timeout name="retraitDesBillets" duration="10" unit="seconds" />
      <xi:include href="./Controleur.automaton" />
      <implementation language="C" src-dir="Controleur-c/src-gen" module-name="UDT" />
      <implementation language="C++" src-dir="Controleur-cpp/src-gen" module-name="hpms::udt" />
      <implementation language="Java" src-dir="Controleur-java/src-gen" module-name="hpms.udt" />
   </component>

   <component name="Banque">
      <offers interface="SiteCentral" />
      <requires interface="Maintenable" />
      <implementation language="C" src-dir="Banque-c/src-gen" module-name="SC" />
      <implementation language="C++" src-dir="Banque-cpp/src-gen" module-name="hpms::sc" />
      <implementation language="Java" src-dir="Banque-java/src-gen" module-name="hpms.sc" />
   </component>

   <deployment name="isolated">
      <process name="sc" address="127.0.0.1" port="2416">
         <instance name="sc" component="Banque">
            <requires interface="Maintenable">
               <from-instance name="udt1" />
               <from-instance name="udt2" />
            </requires>
         </instance>
      </process>
      <process name="udt1" address="127.0.0.1" port="2417">
         <instance name="udt1" component="Controleur">
            <requires interface="IHM"><from-instance name="ihm1" /></requires>
            <requires interface="SiteCentral"><from-instance name="sc" /></requires>
         </instance>
      </process>
      <process name="ihm1" address="127.0.0.1" port="2418">
         <instance name="ihm1" component="Distributeur">
            <requires interface="Maintenable"><from-instance name="udt1" /></requires>
            <requires interface="UniteDeTraitement"><from-instance name="udt1" /></requires>
         </instance>
      </process>
      <process name="udt2" address="127.0.0.1" port="2419">
         <instance name="udt2" component="Controleur">
            <requires interface="IHM"><from-instance name="ihm2" /></requires>
            <requires interface="SiteCentral"><from-instance name="sc" /></requires>
         </instance>
      </process>
      <process name="ihm2" address="127.0.0.1" port="2420">
         <instance name="ihm2" component="Distributeur">
            <requires interface="Maintenable"><from-instance name="udt2" /></requires>
            <requires interface="UniteDeTraitement"><from-instance name="udt2" /></requires>
         </instance>
      </process>
   </deployment>

   <deployment name="mixed">
      <process name="sc" address="127.0.0.1" port="2416">
         <instance name="sc" component="Banque">
            <requires interface="Maintenable">
               <from-instance name="udt1" />
               <from-instance name="udt2" />
            </requires>
         </instance>
      </process>
      <process name="dab1" address="127.0.0.1" port="2417">
         <instance name="udt1" component="Controleur">
            <requires interface="IHM"><from-instance name="ihm2" /></requires>
            <requires interface="SiteCentral"><from-instance name="sc" /></requires>
         </instance>
         <instance name="ihm1" component="Distributeur">
            <requires interface="Maintenable"><from-instance name="udt2" /></requires>
            <requires interface="UniteDeTraitement"><from-instance name="udt2" /></requires>
         </instance>
      </process>
      <process name="dab2" address="127.0.0.1" port="2418">
         <instance name="udt2" component="Controleur">
            <requires interface="IHM"><from-instance name="ihm1" /></requires>
            <requires interface="SiteCentral"><from-instance name="sc" /></requires>
         </instance>
         <instance name="ihm2" component="Distributeur">
            <requires interface="Maintenable"><from-instance name="udt1" /></requires>
            <requires interface="UniteDeTraitement"><from-instance name="udt1" /></requires>
         </instance>
      </process>
   </deployment>

   <deployment name="allin">
      <process name="one" address="127.0.0.1" port="2416">
         <instance name="sc" component="Banque">
            <requires interface="Maintenable">
               <from-instance name="udt1" />
               <from-instance name="udt2" />
            </requires>
         </instance>
         <instance name="udt1" component="Controleur">
            <requires interface="IHM"><from-instance name="ihm1" /></requires>
            <requires interface="SiteCentral"><from-instance name="sc" /></requires>
         </instance>
         <instance name="ihm1" component="Distributeur">
            <requires interface="Maintenable"><from-instance name="udt1" /></requires>
            <requires interface="UniteDeTraitement"><from-instance name="udt1" /></requires>
         </instance>
         <instance name="udt2" component="Controleur">
            <requires interface="IHM"><from-instance name="ihm2" /></requires>
            <requires interface="SiteCentral"><from-instance name="sc" /></requires>
         </instance>
         <instance name="ihm2" component="Distributeur">
            <requires interface="Maintenable"><from-instance name="udt2" /></requires>
            <requires interface="UniteDeTraitement"><from-instance name="udt2" /></requires>
         </instance>
      </process>
   </deployment>

</distributed-application>
